import random
from collections import Counter


def cal_coverage(to_cal):
    """
    to_cal: the mosaic to evaluate (list of sequences)
    test_set: nature epitope (list of epitope list)
    return: the coverage of input mosaic
    """
    epitope_mosaic = set([seq[i:i+epitope_length] for seq in to_cal for i in range(len(seq)-epitope_length)])
    covers = [epitope_count.get(epi, 0) for epi in epitope_mosaic]
    return sum(covers) / num_epitope_nature


def read_fasta(path):
    seq_dict = {}
    with open(path) as f:
        for line in f:
            if line.startswith(">"):
                label = line[1: -1]
                seq_dict[label] = ''
            else:
                seq = line.replace("\n", "").strip()
                seq_dict[label] += seq
    return seq_dict



file_name = "us_na_sampling.fasta"

epitope_length = 9
raw_threshold = 3
population_number = 4
population_size = 500

# 读入序列 并产生天然表位
data = read_fasta("/home/zeng/python_work/bioinfo/mosaic/{}".format(file_name))
seq_list = list(set(data.values()))
num_nature_seqs = len(seq_list)
epitope_nature = [seq[i:i+epitope_length] for seq in seq_list for i in range(len(seq)-epitope_length)]
num_epitope_nature = len(epitope_nature)
epitope_count = Counter(epitope_nature)
no_raw_epitope = {k for k, v in epitope_count.items() if v > raw_threshold}   # 超参数 raw number




mosaic_ha = ["MKTIIALSCILCLVFTQKIPGNDNSTATLCLGHHAVPNGTMVKTITNDRIEVTNATELVQNSSIGEICDSPYQILDGENCTLIDALLGDPQCDGFQNKKWDLFVERSRAYSNCYPYDVPDYASLRSLVASSGTLEFNNESFNWAGVTQNGTSSSCIRGSKSSFFSRLNWLTHLNSKYPALNVTMPNNEQFDKLYIWGVHHPGTDKDQISLYAQSSGRITVSTKRSQQAVIPNIGSRPRIRDIPSRISIYWTIVKPGDILLINSTGNLIAPRGYFKIRSGKSSIMRSDAPIGKCKSECITPNGSIPNDKPFQNVNRITYGACPRYVKQSTLKLATGMRNVPERQTRGIFGAIAGFIENGWEGLVDGWYGFRHQNSEGRGQAADLKSTQAAIDQINGKLNRLIGKTNEKFHQIEKEFSEVEGRIQDLEKYVEDTKIDLWSYNAELLVALENQHTIDLTDSEMNKLFEKTKKQLRENAEDMGNGCFKIYHKCDNACMGSIRNGTYDHNVYRDEALNNRFQIKGVELKSGYKDWILWISFAISCFLLCVALLGFIMWACQKGNIRCNICI",
"MKTIIALSYILCLVFAQKLPGNDNSTATLCLGHHAVPNGTIVKTITNDQIEVTNATELVQSSSTGEICNSPHQILDGENCTLIDALLGDPQCDGFQNKKWDLFVERSKAYSNCYPYDVPDYASLRSLVASSGTLEFKNESFNWTGVTQNGKSSACIRRSSSSFFSRLNWLTHLNYTYPALNVTMPNKEQFDKLYIWGVHHPGTDKDQIFLYAQSSGRITVSTKRSQQAVIPNIGSRPRIRDIPSRISIYWTIVKPGDILLINSTGNLIAPRGYFKIQSGKSSIMRSDAPIGKCKSECITPNGSIPNDKPFQNVNRITYGACPRYVKHSTLKLATGMRNVPEKQTRGIFGAIAGFIENGWEGMVDGWYGFRHQNSEGRGQAADLKSTQAAIDQINGKLNRLIGKTNEKFHQIEKEFSEVEGRIQDLEKYVEDTKIDLWSYNAELLVALENQHTIDLTDSEMNKLFEKTKKQLRENAEDMGNGCFKIYHKCDNACIGSIRNGTYDHDVYRDEALNKRFQIKGIELKSGYKDWILWISFAISCFLLCVALLGFIMWACQKGNIRCNICI",
"MKTIIAFSCILCLIFAQKLPGSDNSMATLCLGHHAVPNGTLVKTITDDQIEVTNATELVQSSSTGRICNSPHQILDGKNCTLIDALLGDPHCDDFQNKEWDLFVERSTAYSNCYPYYVPDYATLRSLVASSGNLEFTQESFNWTGVAQDGSSYACRRGSVNSFFSRLNWLYNLNYKYPEQNVTMPNNDKFDKLYIWGVHHPGTDKDQTNLYVQASGRVIVSTKRSQQTVIPNIGSRPRIRNIPSRISIYWTIVKPGDILLINSTGNLIAPRGYFKIRSGKSSIMRSDAPIGKCNSECITPNGSIPNDKPFQNVNRITYGACPRYVKQNTLKLATGMRNVPEKQTRGIFGAIAGFIENGWEGMVDGWYGFRHQNSEGTGQAADLKSTQAAINQITGKLNRVIKKTNEKFHQIEKEFSEVEGRIQDLEKYVEDTKIDLWSYNAELLVALENQHTIDLTDSEMSKLFERTRRQLRENAEDMGNGCFKIYHKCDNACIGSIRNGTYDHDIYRNEALNNRFQIKGVQLKSGYKDWILWISFAISCFLLCVVLLGFIMWACQKGNIRCNICI",
"MKTIIALSYILCLVFAQKIPGNDNSTATLCLGHHAVPNGTIVKTITNDRIEVTNATELVQNSSIGEICDSPHQILDGENCTLIDALLGDPQCDGFQNKKWDLFVERSKAHSNCYPYDVPDYASLRSLVASSGTLEFNNESFNWTGVTQNGTSSACIRRSNNSFFSRLNWLTHLNFKYPALNVTMPNNEQFDKLYIWGVHHPGTDKDQIFLYAQASGRITVSTKRSQQAVIPNIGSRPRVRNIPSRVSIYWTIVKPGDILLINSTGNLIAPRGYFKIRNGKSSIMRSDAPIGKCNSACITPNGSIPNDKPFQNVNRITYGACPRYVKQNTLKLATGMRNVPEKQTRGIFGAIAGFIENGWEGMMDGWYGFRHQNSEGRGQAADLKSTQAAIDQINGKLNRLIGKTNEKFHQIEKEFSEVEGRVQDLEKYVEDTKIDLWSYNAELLVALENQHTIDLTDSEMNKLFEKTKKQLRENAEDMGNGCFKIYHKCDNACIGSIRNETYDHNVYRDEALNNRFQIKGVELKSGYKDWILWISFAISCFLLCVALLGFIMWACQKGNIRCNICI"]

mosaic_na = ["MNPNQKIITIGSVSLTISTICFFMQIAILITTVTLHFKQYEFNPPPNNQVMLCEPTIIERNITEIVYLTNTTIEREICPKPAEYRNWSKPQCGITGFAPFSKDNSIRLSAGGDIWVTREPYVSCDPDKCYQFALGQGTTINNVHSNNTARDRTPHRTLLMSELGVPFHLGTKQVCIAWSSSSCHDGKAWLHVCITGNDNNATASFIYNGRLVDSIGSWSKNILRTQESECVCINGTCTVVMTDGSASGKADTKILFVEEGKIVHISTLSGSAQHVEECSCYPRFPGVRCVCRDNWKGSNRPIVDINIKDHSIVSSYVCSGLVGDTPRKTDSSSSSHCLNPNNEKGGHGVKGWAFDEGNDVWMGRTINETSRLGYETFKVVEGWSNSKSKLQINRQVIVDRGDRSGYSGIFSVEGKSCINRCFYVELIRGRKEETEVLWTSNSIVVFCGTSGTYGTGSWPDGADLNLMHI",
"MNPNQKIITIGSVSLTISTICFFMQIAILITTVTLHFKQYEFNSPPNNQVMLCEPTIIERNITEIVYLTNTTIEKEICPKPAEYRNWSKPQCGITGFAPFSKDNSIRLSAGGDIWVTREPYVSCDPDKCYQFALGQGTTLNNVHSNNTVRDRTPYRTLLMNELGVPFHLGTKQVCMAWSSSSCHDGKAWLHVCITGDDKNATASFIYNGKLVDSVVSWSKDILRTQESECVCINGTCTVVMTDGNATGKADTKILFIEEGKIVHTSKLSGSAQHVEECSCYPRYPGVRCVCRDNWKGSNRPIVDINIKDHSIVSSYVCSGLVGDTPRKSDSSSSSHCLNPNNEEGGHGVKGWAFDDGNDVWMGRTINETSRLGYETFKVVEGWSNPKSKLQINRQVIVDRGDRSGYSGIFSVEGKSCINRCFYVELIRGRKEETEVLWTSNSIVVFCGTSGTYGTGSWPDGADLNLMHI",
"MNPNQKIITIGSVSLTISTICFFMQIAILITTVTLHFKQYEFNSPPNNQVMLCEPTIIERNITEIVYLTNTTIEKEICPKLAEYRNWSKPQCDITGFAPFSKDNSIRLSAGGDIWVTREPYVSCDPDKCYQFALGQGTTLNNVHSNNTVRXRTPYRTLLMNELGVPFHLGTKQVCIAWSSSSCHDGKAWLHVCITGDDKNATASFIYNGRLVDSVVSWSNDILRTQESECVCINGTCTVVMTDGNATGKADTKILFIEEGKIVHTSKLSGSAQHVEECSCYPRYPGVRCVCRDNWKGSNRPIVDINIKDHSIVSSYVCSGLVGDTPRKNDSSSSSHCLDPNNEEGGHGVKGWAFDDGNDVWMGRTINETSRLGYETFKVIEGWSNPKSKLQMNRQVIVDRGNRSGYSGIFSVEGKSCINRCFYVELIRGRKEETEVLWTSNSIVVFCGTSGTYGTGSWPDGADLNLMPI",
"MNPNQKIITIGSVSLIIATICFLMQVAILVTTVTLHFKQHDCDSSPNNQVMFCEPTIIERNKTEIVYLTNTTVEKEICPKPAEYRNWSKPQCNITGFAPFSKDNSIRLSAGGDIWVTREPYVSCDPDKCYQFALGQGTTLNNGHSNDTVHDRTPYRTLLMNELGVPFHLGTRQVCIAWSSSSCHDGKAWLHVCITGDDKNATASFIYNGRLVDSVVSWSKEILRTQESECVCINGTCTVVMTDGSASGKAVTKILFIEEGKIVHTSTLSGSAQHVEECSCYPRYPGVRCVCRDNWKGSNRPIVDINVKDYSIVSSYVCSGLVGDTPRKNDSFSSSHCLDPNNEEGGHGVKGWAFDDGNDVWMGRTISEKSRLGYETFKVIKGWSKPNSKLQTNRQVIVGRGNRSGYSGIFSVEGKNCINRCFYVELIRGRKEETKVWWTSNSIVVFCGTSGTYGTGSWPDGADINLMPI"]

mosaic_ha_ref = ["MKTIIALSCILCLVFTQKIPGNDNSTATLCLGHHAVSNGTIVKTITNDRIEVTNATELVQSSSAGEICDSPHQILDGGNCTLIDALLGDPQCDGFQNKKWDLFVERSRAYSNCYPYDVPDYASLRSLVASSGTLEFNNESFNWAGVTQNGTSSSCIRGSNSSFFSRLNWLTHLNSKYPALNVTMPNNEQFDKLYIWGIHHPGTDKDQISLYAQSSGRITVSTKGSQQAVIPNIGSRPRIRDIPSRISIYWTIVKPGDILLINSTGNLIAPRGYFKIRSGKSSIMRSDAPIGKCNSECITPNGSIPNDKPFQNVNKITYGACPRYVKQSTLKLATGMRNVPERQTRGIFGAIAGFIENGWEGLVDGWYGFRHQNSEGRGQAADLKSTQAAIDQINGKLNRLIGKTNEKFHQIEKEFSEVEGRIQDLEKYVEDTKIDLWSYNAELLVALENQHTIDLTDAEMNKLFEKTKKQLRENAEDTGNGCFKIYHKCDNACIESIRNGTYDHDIYRNEALNNRFQIKGVELKSGYKDWILWISFAISCFLLCVALLGFIMWACQKGNIRCNICI",
"MKTIIALSYILCLVFAQKLPGNDNSTATLCLGHHAVPNGTIVKTITNDQIEVTNATELVQSSSTGEICDSPHHILDGENCTLIDALLGDPHCDDFQNKEWDLFVERSKAHSNCYPYDVPDYASLRSLIASSGTLEFNNESFNWTGVTQNGTSSACIRRSNNSFFSRLNWLTHLNFKYPALNVTMPNKEQFDKLYIWGVHHPGTDNDQIFLYAQASGRITVSTKRSQQTAIPNIGSRPRVRNIPSRVSIYWTIVKPGDILLINSTGNLIAPRGYFKILSGKSSIMRSDAPIGKCNSACITPNGSISNDKPFQNVNKITYGACPRYVKQNTLKLATGMRNVPEKQTRGIFGAIAGFIENGWEGMMDGWYGFRHQNSEGRGQAADLKSTQAAIDQINGKLNRLIGKTNEKFHQIEKEFSEVEGRVQDLEKYVEDTKIDLWSYNAELLVAMENQHTIDLTDSEMNKLFEKTRKQLRENAEDMGNGCFTIYHKCDNACIGSIRNGTYDHDVYRDEALNKRFQIKGIELKSGYKDWILWISFATSCFLLCVALLGFIMWACQKGNIRCNICI",
"MKTIIAFSCILCLIFAQKLPGSDNSMATLCLGHHAVPNGTLVKTITDDQIEVTNATELVQSSSTGEICNSPHQILDGKNCTLIDALLGDPQCDGFQNRKWDLFVERNKAYSNCYPYYVPDYATLRSLVASSGNLEFTQESFNWTGVKQNGTSSACIRKSSSSFFSRLNWLYNLNYKYPEQNVTMPNNDKFDKLYIWGVHHPGTDKDQIFLYAQAAGRITVSTKRSQQTVIPNIGSRPWVRGVSSIISIYWTIVKPGDILLINSTGNLIAPRGYFKIQSGKSSIMRSDAHIDECNSECITPNGSISNDKPFQNVNRITYGACPRYVKHSTLKLATGMRNVPEKQARGIFGAIAGFIENGWEGMVDGWYGFRHQNSEGTGQAADLKSTQAAINQITGKLNRVIKKTNEKFHQIEKEFSEVEGRVQDLEKYVEDTKIDLWSYNAELLVALENQHTIHLTDSEMNKLFEKTKKQLRENAEDMGNGCFKIYHKCNNACIGSIRNETYDHNVYRDEALNNRFQIKGVQLKSGYKDWILWISFAISCFLLCVVLLGFIMWACQKGNIRCNICI",
"MKTIIALSCILCLVFAQKIPGNDNSMATLCLGHHAVPNGTIVKTITSDRIEVTNATELVQNSSIGEICDSPHQILDGENCTLIDALLGDPQCDGFQNKRWDLFVERSKAYSNCYPYDVPNYASLRSLVASSGTLEFKNESFNWTGVTQNGKSSACIRRSSSSFFSRLNWLTHLNYTYPALNVTMPNKEQFDKLYIWGVHHPVTDKDQIFLYAQSSGRITVSTKRSQQAVIPNIGSRPRIRNIPSRISIYWTIVKPGDILLINSTGNLIAPRGYFKIRNGKSSIMRSDAPIGKCKSECITPNGSISNDKPFQNVNRVTYGACPRYIKQSTLKLATGMRNVPERQTRGIFGAIAGFIENGWEGMKDGWYGFRHQNSEGRGQAADLKSTQAAIDQINGKLNRLIGKTNEKFHQIEKEFSEVEGRVQDLEKYVEDTKIDLWSYNAELLVALENQHTIDLTDSEMSKLFERTRRQLRENAEDMGNGCFRIYHKCDNACMGSIRNGTYDHNVYRDEALNNRFHIKGVELKSGYKDWILWISFAISCFLLCIALLGFIMWACQKGNIRCNICI"]

mosaic_na_ref = ["MNPNQKIITIGSVSLTISTICFFMQVAILITTVTLHFKQYEFNPPPNNQVMLCEPTTIERNITEIVYLTNITIEKEICPKPTEYRNWSKPQCNITGFAPFSKDNSIRLSAGGDIWVTREPYVSCDLDKCYQFALGQGTTLNNMHSNNTVRDRTPFRTLLMNELGVPFHLGTRQVCMAWSSSSCHDGKAWLHVCITGDDRNATASFIYNGKLVDSVVSWSKEILRTQESECVCINGTCTVVMTDGSASGKAVTKILFIEEGKIVHTSTLSGSAQHVEECSCYPRYPGVRCVCRDNWRGSNRPIVDINIKDHSIVSSYLCSGLVGDTPRKNDSSSSSHCLDPNNEEGGHGVKGWAFDDGDDVWMGRTINETSRLGYETFKVIEGWSNPKSKLQTNRQVIVDRGNRSGYSGIFSIEGKSCINRCFYVELIRGRKEETKVWWTSNSIVVFCGTSGTYGTGSWPDGANINLMPI",
"MNPNQKIITIGSVSLIIATICFLMQVAILVTTVTLHFKQHDCDSSPNNQVMFCEPTIIERNKTEIVYLTNTTVEKEICPKPAEYRNWSKPQCDITGFAPFSKDNSIRLSAGGDIWVTREPYVSCDPDRCYQFALGQGTTLNNGHSNDTVHDRTPYRTLLMNELGVPFHLGTRQVCIAWSSSSCHDGKAWLHVCITGNDNNATASFIYNGRLVDSIGSWSKNILRTQESECVCIDGTCTVVMTDGNATGKADTKILFIEEGKIIHISTLSGSAQHVEECSCYPRYPGVRCICRDNWKGSNRPIVDINVKDYSIVSSYVCSGLVGDTPRKNDRSSSSHCSDPNNEEGGHGVKGWAFDDGNDVWMGRTINETLRLGYETFKVIKGWSKPNSKLQTNRQVIVGRGNRSGYSGIFSVEGKNCINRCFYVELIRGRKEETKVLWTSNSIVVFCGTSGTYGTGSWPDGADINLMPI",
"PNQKIITIGSVSLTISTICFLMQIAILVTTVTLHFKQYKFNSPPNNQVMLCEPTIIERNTTEIVYLTNTTIEKEICPKLAEYRNWSKPQCGITGFAPFSKDNSIRLSAGGNIWVTREPYVSCDPDKCYQFALGQGTTLNNVHSNNTVRDRTPYRTLLMSELGVPFHLGTKQVCMAWSSSSCHDGKAWLHVCITGDDKNATASFIYNGRLVDSVVSWSNDILRTQESECVCINGTCTVVMTDGSASGKADTKILFVEEGKIVHISKLSGSAQHVEECSCYPRFPGVRCVCRDNWKGSNRPIVDINMKDHSIVSSYVCSGLVGDTPRKSDSSSSSHCLNPNNEEGGHGVKGWAFDEGNDVWMGRTINETSRFGYETFKVVEGWSNPKSKLQINRQVIVDKGNRSGYSGIFSVEGKSCINRCFYVELIRGRKEETEVLWTSNSIVVFCGTSGTYGTGSWPDGADLNLMPI",
"MNPNQKIISIGSVSLTISTICFFMQIAILITTVTLHFKQYEFNSPPNNQVVLCEPTIIERNITEIVYLTNTTIEREICPKPAEYRNWSKPQCDITGFAPFSKDNSIRLSAGGDIWVTREPYVSCDPNKCYQFALGQGTTINNVHSNNTARDRTPHRTLLMSELGVPFHLGTKQVCIAWSSSSCHDGKAWLHVCVTGDDKNATASFIYNGKLVDSVVSWSKDILRTQESECVCINGTCAVVMTDGSASGEADTKILFIEEGKIVHTSKLSGSAQHVEECSCYPRFPGVRCVCRDNWKGSNRPIIDINIKDHSIVSRYVCSGLVGDTPRKTDSSSSSHCLNPNNEKGGHGVKGWAFDDGNDVWMGRTISEKSRLGYETFKVVEGWSNSKSKLQINRQVIVDRGDRSGYSGIFSVESKSCINRCFYVELIRGRKEETEVLWTSNSIVVFCGTSGTYGTGSWPDGADLNLMHI"]

# print(cal_coverage(mosaic_ha))
# print(cal_coverage(mosaic_ha_ref))
print(cal_coverage(mosaic_na))
print(cal_coverage(mosaic_na_ref))
